name: Docker Image Build, Test and Push to GCR

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
    
env:
  REGISTRY: gcr.io
  IMAGE_NAME: task
  
jobs:

  build:

    runs-on: ubuntu-latest
    outputs: 
      image-tag: ${{ steps.set-tag.outputs.image-tag }}

    steps:
    - uses: actions/checkout@v4
  
    - name: Install hadolint
      run: |
        wget -O /usr/local/bin/hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
        chmod +x /usr/local/bin/hadolint

    - name: Run Dockerfile lint
      run: hadolint Dockerfile

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install Python linter (ruff)
      run: pip install ruff

    - name: Run Python lint
      run: ruff check

  #Run Unit test with coverage if there is any
  #Pass to SonarQube
  
    - name: Install Gitleaks v8.29.0
      run: |
        curl -sSL -o gitleaks_8.29.0_linux_x64.tar.gz https://github.com/gitleaks/gitleaks/releases/download/v8.29.0/gitleaks_8.29.0_linux_x64.tar.gz
        tar -zxvf gitleaks_8.29.0_linux_x64.tar.gz
        chmod +x gitleaks
        sudo mv gitleaks /usr/local/bin/gitleaks
        gitleaks version
   
    - name: Run Gitleaks scan
      run: gitleaks detect --source=. --exit-code=1
      
    - name: Docker Build 
      run: |  
        IMAGE_TAG=app:$(date +%s)
        docker build . --file Dockerfile --tag $IMAGE_TAG
        docker tag $IMAGE_TAG ${{ env.IMAGE_NAME }}:${{ github.sha }}
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
    
    - name: Set image tag output
      id: set-tag
      run: |
        echo "image-tag=${{ github.sha }}" >> $GITHUB_OUTPUT
        
    - name: Save Docker image to artifact
      run: |
        docker save ${{ env.IMAGE_NAME }}:${{ github.sha }} -o image.tar

    - name: Upload Docker image artifact
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: image.tar
        retention-days: 1
        
    - name: Trivy vulnerability scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.IMAGE_TAG }}
        format: 'table'
        output: 'trivy-results.txt'
        exit-code: 0
        skip-version-check: true
        
    - name: Run container smoke test
      run: |
        # Run container in detached mode
        CONTAINER_ID=$(docker run -d -p 5000:5000 ${{ env.IMAGE_TAG }})

        # Wait a few seconds for it to start
        sleep 30
    
        # Check container is running
        docker ps --filter "id=$CONTAINER_ID"
        CONTAINER_STATUS=$(docker inspect $CONTAINER_ID --format='{{.State.Health.Status}}')
        if [ "$CONTAINER_STATUS" != "healthy" ]; then
          exit 1
        fi
        echo "Container is up and running"
        #Another Check 
        curl -f http://localhost:5000/health

        
    #Run OWASP for DAST testing  
    - name: OWASP ZAP scan
      uses: zaproxy/action-baseline@v0.10.0
      continue-on-error: true
      with:
        target: 'http://localhost:5000/health'
        cmd_options: '-m 2 -I -a -s'
    
    #Upload to artifact        
    - name: Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: security-scan-results
        path: |
          trivy-results.txt
          trivy-report.html
          report_json.json
          report_md.md
          report_html.html
          
    - name: Cleanup container
      if: always()
      run: |
        if [ -n "$CONTAINER_ID" ]; then
          docker stop $CONTAINER_ID || true
          docker rm $CONTAINER_ID || true
          echo "Container cleaned up"
        else
          echo "No container to clean up"
        fi

  push-to-gcr:
    runs-on: ubuntu-latest
    needs: build  
    if: always() && needs.build.result == 'success'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Configure Docker
      run: gcloud auth configure-docker europe-west3-docker.pkg.dev --quiet
      
    - name: Download Docker image artifact
      uses: actions/download-artifact@v4
      with:
        name: docker-image

    - name: Load Docker image
      run: |
        docker load -i image.tar
        
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: optical-legend-477521-b8      


    - name: Pull and Push to GCR
      run: |
        REGISTRY_LOCATION=europe-west3
        docker tag task:${{ needs.build.outputs.image-tag }} europe-west3-docker.pkg.dev/optical-legend-477521-b8/task/task:${{ needs.build.outputs.image-tag }}
        docker tag task:${{ needs.build.outputs.image-tag }} europe-west3-docker.pkg.dev/optical-legend-477521-b8/task/task:latest
        
        echo "Pushing to Artifact Registry..."
        docker push europe-west3-docker.pkg.dev/optical-legend-477521-b8/task/task:${{ needs.build.outputs.image-tag }}
        docker push europe-west3-docker.pkg.dev/optical-legend-477521-b8/task/task:latest


    - name: Verify pushed images
      run: |
        echo "Images pushed to GCR:"
        gcloud artifacts docker tags list europe-west3-docker.pkg.dev/optical-legend-477521-b8/task

  update-gitops-repo:
    runs-on: ubuntu-latest
    needs: push-to-gcr
    if: always() && needs.push-to-gcr.result == 'success'
    
    steps:
      - name: Checkout GitOps Repository
        uses: actions/checkout@v4
        with:
          repository: mounirbasta/k8s
          token: ${{ secrets.GITOPS_PAT }}
          path: gitops-repo
  
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
  
      - name: Debug - Check Repository Access
        run: |
          cd gitops-repo
          echo "Current directory:"
          pwd
          echo "Repository contents:"
          ls -la
          echo "Deployments directory contents:"
          ls -la deployments/
          echo "Current image in app-dev.yaml:"
          yq eval '.spec.template.spec.containers[0].image' deployments/app-dev.yaml || echo "yq command failed"
          grep "image:" deployments/app-dev.yaml  

      - name: Update Deployment YAML
        run: |
          cd gitops-repo
          NEW_IMAGE="europe-west3-docker.pkg.dev/optical-legend-477521-b8/task/task:${{ github.sha }}"
          echo "Updating to image: $NEW_IMAGE"
          
          # Update the image in the deployment file
          yq eval ".spec.template.spec.containers[0].image = \"$NEW_IMAGE\"" -i deployments/app-dev.yaml
          
          # Verify the change
          echo "Updated deployment image to:"
          yq eval '.spec.template.spec.containers[0].image' deployments/app-dev.yaml

          cat deployments/app-dev.yaml
          
      - name: Commit and Push Changes
        run: |
          cd gitops-repo
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@users.noreply.github.com"
          git add deployments/app-dev.yaml
          
          # Check if there are changes
          if ! git diff --staged --quiet; then
            git commit -m "chore: update python app image to ${{ github.sha }}"
            git push origin main
            echo "Successfully updated k8s GitOps repository"
          else
            echo "No changes to commit"
          fi

          
